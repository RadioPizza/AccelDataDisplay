/**
 * @file spi.h
 * @brief Библиотека-драйвер для работы с аппаратным интерфейсом SPI
 *
 * Этот файл содержит прототипы функций и необходимые определения для работы с SPI.
 */

#ifndef SPI_H
#define SPI_H

#include <stdint.h> /* Для типов uint8_t и т.д. */

/**
 * @defgroup SPI_CR1 Биты регистра управления SPI_CR1
 * @brief Определения битов регистра SPI_CR1
 * @{
 */
#define SPI_CR1_CPHA    (1 << 0)  /**< @brief Фаза тактового сигнала */
#define SPI_CR1_CPOL    (1 << 1)  /**< @brief Полярность тактового сигнала */
#define SPI_CR1_MSTR    (1 << 2)  /**< @brief Выбор режима мастера */
#define SPI_CR1_BR      (7 << 3)  /**< @brief Управление скоростью передачи (делитель) */
#define SPI_CR1_SPE     (1 << 6)  /**< @brief Включение SPI */
/** @} */ // end of SPI_CR1

/**
 * @defgroup SPI_CR2 Биты регистра управления SPI_CR2
 * @brief Определения битов регистра SPI_CR2
 * @{
 */
#define SPI_CR2_SSI     (1 << 0)  /**< @brief Внутренний выбор подчинённого (Slave Select) */
#define SPI_CR2_SSM     (1 << 1)  /**< @brief Программное управление подчинённым устройством (Slave Management) */
/** @} */ // end of SPI_CR2

/**
 * @defgroup SPI_SR Биты регистра состояния SPI_SR
 * @brief Определения битов регистра состояния SPI_SR
 * @{
 */
#define SPI_SR_RXNE     (1 << 0)  /**< @brief Флаг: Принятые данные доступны в буфере */
#define SPI_SR_TXE      (1 << 1)  /**< @brief Флаг: Буфер передачи пуст */
/** @} */ // end of SPI_SR

/**
 * @defgroup SPI_BAUDRATE Скорости передачи SPI (делители)
 * @brief Определения для управления скоростью передачи данных через SPI
 * @{
 */
#define SPI_BAUDRATE_DIV2     (0 << 3)  /**< @brief Делитель скорости передачи: 2 */
#define SPI_BAUDRATE_DIV4     (1 << 3)  /**< @brief Делитель скорости передачи: 4 */
#define SPI_BAUDRATE_DIV8     (2 << 3)  /**< @brief Делитель скорости передачи: 8 */
#define SPI_BAUDRATE_DIV16    (3 << 3)  /**< @brief Делитель скорости передачи: 16 */
#define SPI_BAUDRATE_DIV32    (4 << 3)  /**< @brief Делитель скорости передачи: 32 */
#define SPI_BAUDRATE_DIV64    (5 << 3)  /**< @brief Делитель скорости передачи: 64 */
#define SPI_BAUDRATE_DIV128   (6 << 3)  /**< @brief Делитель скорости передачи: 128 */
#define SPI_BAUDRATE_DIV256   (7 << 3)  /**< @brief Делитель скорости передачи: 256 */
/** @} */ // end of SPI_BAUDRATE

/**
 * @brief  Инициализация периферийного модуля SPI
 *
 * Эта функция конфигурирует периферийный модуль SPI микроконтроллера STM8S103F3
 * в режиме мастера с заданными настройками. Rонфигурация:
 * - Режим мастера
 * - Делитель частоты тактового сигнала: f_Master/16
 * - Полярность тактового сигнала: CPOL = 0 (активный высокий уровень)
 * - Фаза тактового сигнала: CPHA = 0 (данные считываются по переднему фронту)
 * - Программное управление выбором подчиненного устройства (SS).
 *
 * Настраивает следующие GPIO:
 * - PC6 (MOSI): выход Push-Pull, высокая скорость
 * - PC7 (MISO): вход Floating
 * - PC5 (SCK): выход Push-Pull, высокая скорость
 * - PA3 (CS): выход Push-Pull, высокая скорость
 *
 * @return uint8_t Статус инициализации
 * @retval 0  Успешная инициализация SPI.
 * @retval 1  Ошибка инициализации SPI (не удалось включить SPI).
 *
 * @sa SPI_ReadWriteByte
 * @sa SPI_Enable
 * @sa SPI_Disable
 *
 * @code
 *  // Пример использования:
 *  uint8_t result = SPI_Init();
 *  if (result == 0) {
 *    // SPI успешно инициализирован
 *    // Можно выполнять передачу данных
 *  } else {
 *    // Ошибка инициализации SPI
 *    // Обработка ошибки
 *  }
 * @endcode
 * 
 * @note Перед вызовом функции должно быть включено тактирование микроконтроллера
 * @warning Функция не проверяет корректность настройки тактирования
 */
uint8_t SPI_Init(void);

/**
 * @brief Передача и приём одного байта через SPI
 *
 * Передаёт один байт по шине SPI и одновременно принимает байт с шины SPI.
 *
 * @param data Байт, который нужно передать
 * @return Принятый байт с шины SPI
 */
uint8_t SPI_ReadWriteByte(uint8_t data);

/**
 * @brief Включение периферийного модуля SPI
 *
 * Устанавливает бит SPE в регистре управления SPI для включения периферийного модуля SPI.
 */
void SPI_Enable(void);

/**
 * @brief Выключение периферийного модуля SPI
 *
 * Сбрасывает бит SPE в регистре управления SPI для выключения периферийного модуля SPI.
 */
void SPI_Disable(void);

#endif /* SPI_H */
