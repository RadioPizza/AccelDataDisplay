// ssd1306.c
#include "ssd1306.h"

// Данные шрифта: простой шрифт 5x7, хранимый во FLASH
// Каждый символ занимает 5 байт (столбцов), 7 бит по высоте
const unsigned char font5x7[][5] = {
    // Пробел [32] (код ASCII 32)
    {0x00, 0x00, 0x00, 0x00, 0x00},
    // ! [33]
    {0x00, 0x00, 0x5F, 0x00, 0x00},
    // " [34]
    {0x00, 0x07, 0x00, 0x07, 0x00},
    // # [35]
    {0x14, 0x7F, 0x14, 0x7F, 0x14},
    // $ [36]
    {0x24, 0x2E, 0x7B, 0x2A, 0x12},
    // % [37]
    {0x23, 0x13, 0x08, 0x64, 0x62},
    // & [38]
    {0x36, 0x49, 0x55, 0x22, 0x50},
    // ' [39]
    {0x00, 0x05, 0x03, 0x00, 0x00},
    // ( [40]
    {0x00, 0x1C, 0x22, 0x41, 0x00},
    // ) [41]
    {0x00, 0x41, 0x22, 0x1C, 0x00},
    // * [42]
    {0x14, 0x08, 0x3E, 0x08, 0x14},
    // + [43]
    {0x08, 0x08, 0x3E, 0x08, 0x08},
    // , [44]
    {0x00, 0x50, 0x30, 0x00, 0x00},
    // - [45]
    {0x08, 0x08, 0x08, 0x08, 0x08},
    // . [46]
    {0x00, 0x60, 0x60, 0x00, 0x00},
    // / [47]
    {0x20, 0x10, 0x08, 0x04, 0x02},
    // 0 [48]
    {0x3E, 0x51, 0x49, 0x45, 0x3E},
    // 1 [49]
    {0x00, 0x42, 0x7F, 0x40, 0x00},
    // 2 [50]
    {0x42, 0x61, 0x51, 0x49, 0x46},
    // 3 [51]
    {0x21, 0x41, 0x45, 0x4B, 0x31},
    // 4 [52]
    {0x18, 0x14, 0x12, 0x7F, 0x10},
    // 5 [53]
    {0x27, 0x45, 0x45, 0x45, 0x39},
    // 6 [54]
    {0x3C, 0x4A, 0x49, 0x49, 0x30},
    // 7 [55]
    {0x01, 0x71, 0x09, 0x05, 0x03},
    // 8 [56]
    {0x36, 0x49, 0x49, 0x49, 0x36},
    // 9 [57]
    {0x06, 0x49, 0x49, 0x29, 0x1E},
    // : [58]
    {0x00, 0x36, 0x36, 0x00, 0x00},
    // ; [59]
    {0x00, 0x56, 0x36, 0x00, 0x00},
    // < [60]
    {0x08, 0x14, 0x22, 0x41, 0x00},
    // = [61]
    {0x14, 0x14, 0x14, 0x14, 0x14},
    // > [62]
    {0x00, 0x41, 0x22, 0x14, 0x08},
    // ? [63]
    {0x02, 0x01, 0x51, 0x09, 0x06},
    // @ [64]
    {0x32, 0x49, 0x79, 0x41, 0x3E},
    // A [65]
    {0x7E, 0x11, 0x11, 0x11, 0x7E},
    // B [66]
    {0x7F, 0x49, 0x49, 0x49, 0x36},
    // C [67]
    {0x3E, 0x41, 0x41, 0x41, 0x22},
    // D [68]
    {0x7F, 0x41, 0x41, 0x22, 0x1C},
    // E [69]
    {0x7F, 0x49, 0x49, 0x49, 0x41},
    // F [70]
    {0x7F, 0x09, 0x09, 0x09, 0x01},
    // G [71]
    {0x3E, 0x41, 0x49, 0x49, 0x7A},
    // H [72]
    {0x7F, 0x08, 0x08, 0x08, 0x7F},
    // I [73]
    {0x00, 0x41, 0x7F, 0x41, 0x00},
    // J [74]
    {0x20, 0x40, 0x41, 0x3F, 0x01},
    // K [75]
    {0x7F, 0x08, 0x14, 0x22, 0x41},
    // L [76]
    {0x7F, 0x40, 0x40, 0x40, 0x40},
    // M [77]
    {0x7F, 0x02, 0x0C, 0x02, 0x7F},
    // N [78]
    {0x7F, 0x04, 0x08, 0x10, 0x7F},
    // O [79]
    {0x3E, 0x41, 0x41, 0x41, 0x3E},
    // P [80]
    {0x7F, 0x09, 0x09, 0x09, 0x06},
    // Q [81]
    {0x3E, 0x41, 0x51, 0x21, 0x5E},
    // R [82]
    {0x7F, 0x09, 0x19, 0x29, 0x46},
    // S [83]
    {0x46, 0x49, 0x49, 0x49, 0x31},
    // T [84]
    {0x01, 0x01, 0x7F, 0x01, 0x01},
    // U [85]
    {0x3F, 0x40, 0x40, 0x40, 0x3F},
    // V [86]
    {0x1F, 0x20, 0x40, 0x20, 0x1F},
    // W [87]
    {0x3F, 0x40, 0x38, 0x40, 0x3F},
    // X [88]
    {0x63, 0x14, 0x08, 0x14, 0x63},
    // Y [89]
    {0x07, 0x08, 0x70, 0x08, 0x07},
    // Z [90]
    {0x61, 0x51, 0x49, 0x45, 0x43},
    // [ [91]
    {0x00, 0x7F, 0x41, 0x41, 0x00},
    // \ [92]
    {0x02, 0x04, 0x08, 0x10, 0x20},
    // ] [93]
    {0x00, 0x41, 0x41, 0x7F, 0x00},
    // ^ [94]
    {0x04, 0x02, 0x01, 0x02, 0x04},
    // _ [95]
    {0x40, 0x40, 0x40, 0x40, 0x40},
    // ` [96]
    {0x00, 0x01, 0x02, 0x04, 0x00},
    // a [97]
    {0x20, 0x54, 0x54, 0x54, 0x78},
    // b [98]
    {0x7F, 0x48, 0x44, 0x44, 0x38},
    // c [99]
    {0x38, 0x44, 0x44, 0x44, 0x20},
    // d [100]
    {0x38, 0x44, 0x44, 0x48, 0x7F},
    // e [101]
    {0x38, 0x54, 0x54, 0x54, 0x18},
    // f [102]
    {0x08, 0x7E, 0x09, 0x01, 0x02},
    // g [103]
    {0x0C, 0x52, 0x52, 0x52, 0x3E},
    // h [104]
    {0x7F, 0x08, 0x04, 0x04, 0x78},
    // i [105]
    {0x00, 0x44, 0x7D, 0x40, 0x00},
    // j [106]
    {0x20, 0x40, 0x44, 0x3D, 0x00},
    // k [107]
    {0x7F, 0x10, 0x28, 0x44, 0x00},
    // l [108]
    {0x00, 0x41, 0x7F, 0x40, 0x00},
    // m [109]
    {0x7C, 0x04, 0x18, 0x04, 0x78},
    // n [110]
    {0x7C, 0x08, 0x04, 0x04, 0x78},
    // o [111]
    {0x38, 0x44, 0x44, 0x44, 0x38},
    // p [112]
    {0x7C, 0x14, 0x14, 0x14, 0x08},
    // q [113]
    {0x08, 0x14, 0x14, 0x18, 0x7C},
    // r [114]
    {0x7C, 0x08, 0x04, 0x04, 0x08},
    // s [115]
    {0x48, 0x54, 0x54, 0x54, 0x20},
    // t [116]
    {0x04, 0x3F, 0x44, 0x40, 0x20},
    // u [117]
    {0x3C, 0x40, 0x40, 0x20, 0x7C},
    // v [118]
    {0x1C, 0x20, 0x40, 0x20, 0x1C},
    // w [119]
    {0x3C, 0x40, 0x30, 0x40, 0x3C},
    // x [120]
    {0x44, 0x28, 0x10, 0x28, 0x44},
    // y [121]
    {0x0C, 0x50, 0x50, 0x50, 0x3C},
    // z [122]
    {0x44, 0x64, 0x54, 0x4C, 0x44},
    // { [123]
    {0x00, 0x08, 0x36, 0x41, 0x00},
    // | [124]
    {0x00, 0x00, 0x7F, 0x00, 0x00},
    // } [125]
    {0x00, 0x41, 0x36, 0x08, 0x00},
    // ~ [126]
    {0x08, 0x04, 0x08, 0x10, 0x08},
};

// Вспомогательная функция для отправки команды SSD1306
void SSD1306_WriteCommand(unsigned char command)
{
    I2C_Start();
    I2C_WriteAddress(SSD1306_I2C_ADDRESS); // Адрес I2C + бит записи
    I2C_WriteData(SSD1306_COMMAND);        // Контрольный байт: Co = 0, D/C# = 0
    I2C_WriteData(command);                // Байт команды
    I2C_Stop();
}

// Вспомогательная функция для отправки данных SSD1306
void SSD1306_WriteData(unsigned char data)
{
    I2C_Start();
    I2C_WriteAddress(SSD1306_I2C_ADDRESS); // Адрес I2C + бит записи
    I2C_WriteData(SSD1306_DATA);           // Контрольный байт: Co = 0, D/C# = 1
    I2C_WriteData(data);                   // Байт данных
    I2C_Stop();
}

// Инициализация дисплея SSD1306
void SSD1306_Init(void)
{
    I2C_Init();

    // Последовательность инициализации для SSD1306
    SSD1306_WriteCommand(0xAE); // Выключить дисплей

    SSD1306_WriteCommand(0xD5); // Установка тактовой частоты
    SSD1306_WriteCommand(0x80); // Частота по умолчанию

    SSD1306_WriteCommand(0xA8); // Установка мультиплексного коэффициента
    SSD1306_WriteCommand(0x3F); // 1/64 duty

    SSD1306_WriteCommand(0xD3); // Установка смещения дисплея
    SSD1306_WriteCommand(0x00); // Нет смещения

    SSD1306_WriteCommand(0x40); // Установка стартовой линии

    SSD1306_WriteCommand(0x8D); // Настройка зарядового насоса
    SSD1306_WriteCommand(0x14); // Включить зарядовой насос

    SSD1306_WriteCommand(0x20); // Режим адресации памяти
    SSD1306_WriteCommand(0x00); // Горизонтальный режим адресации

    SSD1306_WriteCommand(0xA1); // Разворот сегментов
    SSD1306_WriteCommand(0xC8); // Направление сканирования COM

    SSD1306_WriteCommand(0xDA); // Конфигурация COM пинов
    SSD1306_WriteCommand(0x12);

    SSD1306_WriteCommand(0x81); // Контрастность
    SSD1306_WriteCommand(0xCF);

    SSD1306_WriteCommand(0xD9); // Установка периода предварительной зарядки
    SSD1306_WriteCommand(0xF1);

    SSD1306_WriteCommand(0xDB); // Установка уровня VCOMH
    SSD1306_WriteCommand(0x40);

    SSD1306_WriteCommand(0xA4); // Восстановить отображение из RAM
    SSD1306_WriteCommand(0xA6); // Нормальный режим отображения

    SSD1306_WriteCommand(0x2E); // Отключить прокрутку

    SSD1306_WriteCommand(0xAF); // Включить дисплей

    SSD1306_Clear(); // Очистить дисплей
}

// Очистить дисплей
void SSD1306_Clear(void)
{
    unsigned char page, column;

    for (page = 0; page < 8; page++)
    {
        SSD1306_WriteCommand(0xB0 | page); // Установка адреса страницы
        SSD1306_WriteCommand(0x00);        // Установка младшего адреса столбца

        SSD1306_WriteCommand(0x10); // Установка старшего адреса столбца

        for (column = 0; column < 128; column++)
        {
            SSD1306_WriteData(0x00); // Очистить данные
        }
    }
}

// Установить курсор в определенный столбец и страницу
void SSD1306_SetCursor(unsigned char column, unsigned char page)
{
    SSD1306_WriteCommand(0xB0 | (page & 0x07));          // Установка адреса страницы
    SSD1306_WriteCommand(0x00 | (column & 0x0F));        // Младший адрес столбца
    SSD1306_WriteCommand(0x10 | ((column >> 4) & 0x0F)); // Старший адрес столбца
}

// Вывести символ на дисплей
void SSD1306_WriteChar(char c)
{
    unsigned char i;
    const unsigned char *bitmap;

    // Проверка на допустимый диапазон символов
    if (c < 32 || c > 126)
    {
        c = ' '; // Заменяем недопустимые символы пробелом
    }

    bitmap = font5x7[c - 32];

    for (i = 0; i < 5; i++)
    {
        SSD1306_WriteData(bitmap[i]);
    }

    SSD1306_WriteData(0x00); // Пробел между символами
}

// Вывести строку на дисплей
void SSD1306_WriteString(const char *str)
{
    while (*str)
    {
        SSD1306_WriteChar(*str++);
    }
}

// Включить дисплей
void SSD1306_DisplayOn(void)
{
    SSD1306_WriteCommand(0xAF);
}

// Выключить дисплей
void SSD1306_DisplayOff(void)
{
    SSD1306_WriteCommand(0xAE);
}

// Нарисовать изображение (ширина должна быть кратна 8)
void SSD1306_DrawBitmap(int x, int y, const unsigned char *bitmap, unsigned char width, unsigned char height)
{
    unsigned char i, j;
    unsigned char byte_height = (height + 7) / 8; // Высота в байтах (сколько страниц занимает по вертикали)
    for (j = 0; j < byte_height; j++)
    { // Проход по страницам
        for (i = 0; i < width; i++)
        { // Проход по пикселям по ширине
            // Установка курсора в нужное место
            SSD1306_SetCursor(x + i, y / 8 + j); // y / 8 — страница
            // Отправка данных из битмапа на дисплей
            SSD1306_WriteData(bitmap[j * width + i]);
        }
    }
}
